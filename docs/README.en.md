# MaaFramework Watchdog

A log-based monitoring system designed for MaaFramework.

Logdog monitors MaaFramework Pipeline execution flow by analyzing log files in real-time. It uses configurable state machines to track task node transitions, detect timeouts, and send alerts via external notifications when operations fail to complete within expected timeframes.

## 1. Features

* Non-intrusive monitoring: Monitors agents through `debug/maa.log` file without process memory injection.
* Complex state machines: Supports multi-step state transitions, e.g.: `Start -> Step 1 -> Step 2 -> End`.
* Timeout detection: Automatically sends alerts if specific nodes or transition steps exceed defined thresholds.
* Entry node detection: Automatically resets currently active states when a new task cycle begins (entry node).
* Multi-platform notifications: 
    * Telegram Bot
    * WeChat Work
* Custom alerts: Filter event types that trigger notifications, e.g.: alert only when timeouts occur.

## 2. Using Source Code

Requires Python 3.8 or above.

1. Clone the repository: 

```bash
git clone git@github.com:MaaGF1/logdog.git
# or
git clone https://github.com/MaaGF1/logdog.git
# Enter directory
cd logdog
```

2. Install dependencies: 

The only external dependency is the `requests` library for sending notifications: 
```bash
pip install requests
```

## 3. Configuration

The system is fully controlled through the `watchdog.conf` file.

### 3.1 Notification Settings

Configure external notification parameters and set notification filter options.

```ini
[Notification]
# Telegram configuration
Bot_Token=123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11
Chat_ID=123456789

# WeChat Work configuration
Webhook_Key=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

# Default platform, available options: 
    # telegram
    # wechat
Default_ExtNotify=wechat

# Notification filter, defines which events trigger message sending, available options: 
    # StateActivated (state activated), 
    # StateCompleted (state completed), 
    # Timeout (timeout), 
    # StateInterrupted (state interrupted), 
    # EntryDetected (entry detected)
# If this line is commented out, all events will be sent.
NotifyWhen={Timeout, StateInterrupted}
```

### 3.2 Monitoring Settings

Point Watchdog to your MaaFramework log file.

```ini
[Monitoring]
# Path to log file generated by MaaFramework
Log_File_Path=../debug/maa.log

# Polling interval (seconds)
Monitor_Interval=1.0
```

### 3.3 State Machine Rules

#### State Rules (`[States]`)
Format: `RuleName={StartNode, TimeoutMS, NextNode, [TimeoutMS, NextNode...], Description}`

* StartNode: Node name that appears in the log to start the timer.
* TimeoutMS: Allowed time to reach the next node (milliseconds).
* NextNode: Expected node to stop the timer or move to the next step.

```ini
[States]
# Simple rule: If 'StartTask' appears, 'EndTask' must appear within 30 seconds
Simple_Task={StartTask, 30000, EndTask, "Basic task monitoring"}

# Complex chain: StartNode -> (5s) -> SwitchNode1
#               (or) -> (10s) -> SwitchNode2
Complex_Flow={StartNode, 5000, SwitchNode1, 10000, SwitchNode2, "Complex flow chain"}
```

#### Entry Nodes (`[Entries]`)

Nodes that mark the beginning of major workflows. When such nodes are detected, all currently active states/timers are reset (considered interrupted).

```ini
[Entries]
# Format: Name={NodeName, Description}
Main_Entry={Task_Start_Node, "Main task entry point"}
```

#### Completion Nodes (`[Completed]`)

Nodes that explicitly mark rules as successfully completed.

```ini
[Completed]
# Format: Name={NodeName, Description}
Task_Done={Task_Success_Node, "Task completed successfully"}
```

## 4. Usage

### 4.1 Starting Watchdog

Run the main script. It will block and monitor the log file indefinitely.

```bash
python main.py
```

### 4.2 Command Line Arguments

* `--config <path>`: Specify custom configuration file path.
* `--status`: Print current state of the state machine and exit.
* `--detailed-status`: Print detailed information about active states, transitions and timers.
* `--daemon`: (Linux) Run in background mode.

Example:

```bash
python main.py --config ./my_configs/watchdog.conf
```

## 5. How it works

1. Log parsing: `LogMonitor` reads new lines from `maa.log`. It looks for patterns like `[pipeline_data.name=NodeName] | enter`.
2. State activation: If a detected node matches a `StartNode` in `[States]`, a new `WatchdogState` is activated and timing begins.
3. Transition/completion: 
    * If the target node appears within the time limit, the rule is marked as Completed (or moves to the next step).
    * If the time limit has passed, a Timeout event is triggered.
4. Notification: Based on `NotifyWhen` settings, `WatchdogNotifier` sends alerts to configured platforms.