# MaaFramework Watchdog

A log-based monitoring system designed for **MaaFramework**. 

The Watchdog monitors the execution flow of your MaaFramework agent by analyzing log files in real-time. It utilizes a configurable State Machine to track task transitions, detect timeouts, and send alerts via Telegram or WeChat Work when operations fail to complete within expected timeframes.

## ðŸŒŸ Features

*   **Non-Invasive Monitoring**: Monitors the agent via `maa.log` files without injecting into the process memory.
*   **Complex State Machine**: Supports multi-step transition rules (e.g., `Start -> Step 1 -> Step 2 -> End`).
*   **Timeout Detection**: Automatically alerts if a specific node or transition takes longer than the defined threshold.
*   **Entry Node Detection**: Automatically resets active states when a new task cycle begins (Entry Node).
*   **Multi-Platform Notifications**: 
    *   Telegram Bot
    *   WeChat Work (Enterprise WeChat)
*   **Customizable Alerts**: Filter which events trigger notifications (e.g., only alert on Timeouts).

## ðŸ“‹ Prerequisites

*   Python 3.8+

## ðŸ“¦ Installation

1.  **Clone the repository** (or download the source code):
    ```bash
    git clone git@github.com:MaaGF1/logdog.git
    cd logdog
    ```

2.  **Install dependencies**:
    The only external dependency is `requests` for sending notifications.
    ```bash
    pip install requests
    ```

## âš™ï¸ Configuration

The system is controlled entirely via `watchdog.conf`.

### 1. Notification Settings
Configure your IM bots and the new **Notification Filtering** feature.

```ini
[Notification]
# Telegram Configuration
Bot_Token=123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11
Chat_ID=123456789

# WeChat Work Configuration
Webhook_Key=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

# Default Platform (telegram or wechat)
Default_ExtNotify=wechat

# [NEW] Notification Filtering
# Define which events trigger a message.
# Available options: StateActivated, StateCompleted, Timeout, StateInterrupted, EntryDetected
# If commented out, ALL events are sent.
NotifyWhen={Timeout, StateInterrupted}
```

### 2. Monitoring Settings
Point the watchdog to your MaaFramework log file.

```ini
[Monitoring]
# Path to the log file generated by MaaFramework
Log_File_Path=../debug/maa.log

# Check interval in seconds
Monitor_Interval=1.0
```

### 3. State Machine Rules
Define the logic for monitoring tasks.

**State Rules (`[States]`)**
Format: `RuleName={StartNode, TimeoutMS, NextNode, [TimeoutMS, NextNode...], Description}`

*   **StartNode**: The node name in the log that starts the timer.
*   **TimeoutMS**: Time in milliseconds allowed to reach the next node.
*   **NextNode**: The expected node to stop the timer or advance to the next step.

```ini
[States]
# Simple rule: If 'StartTask' appears, 'EndTask' must appear within 30s
Simple_Task={StartTask, 30000, EndTask, "Basic Task Monitor"}

# Complex chain: Start -> (5s) -> Mid -> (10s) -> End
Complex_Flow={StartNode, 5000, MidNode, 10000, EndNode, "Complex Chain"}
```

**Entry Nodes (`[Entries]`)**
Nodes that signify the start of a major workflow. When detected, **ALL** currently active states/timers are reset (Interrupted).

```ini
[Entries]
# Format: Name={NodeName, Description}
Main_Entry={Task_Start_Node, "Main Task Entry Point"}
```

**Completion Nodes (`[Completed]`)**
Nodes that explicitly mark a rule as successfully finished.

```ini
[Completed]
# Format: Name={NodeName, Description}
Task_Done={Task_Success_Node, "Task Finished Successfully"}
```

## ðŸš€ Usage

### Start the Watchdog
Run the main script. It will block and monitor the log file indefinitely.

```bash
python main.py
```

### Command Line Arguments

*   `--config <path>`: Specify a custom configuration file path.
*   `--status`: Print the current status of the state machine and exit.
*   `--detailed-status`: Print detailed information about active states, transitions, and timers.
*   `--daemon`: (Linux) Run in background mode.

**Example:**
```bash
python main.py --config ./my_configs/watchdog.conf
```

## ðŸ§© How it Works

1.  **Log Parsing**: The `LogMonitor` reads new lines from `maa.log`. It looks for patterns like `[pipeline_data.name=NodeName] | enter`.
2.  **State Activation**: If a detected node matches a `StartNode` in `[States]`, a new `WatchdogState` is activated, and a timer starts.
3.  **Transition/Completion**: 
    *   If the target node appears within the time limit, the rule is marked as **Completed** (or moves to the next step).
    *   If the time limit expires, a **Timeout** event is triggered.
4.  **Notification**: Based on the `NotifyWhen` setting, the `WatchdogNotifier` sends an alert to the configured platform.